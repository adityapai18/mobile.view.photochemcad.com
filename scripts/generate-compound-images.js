#!/usr/bin/env node
/**
 * Scans assets/database for {database_name}/{compound_id}/{compound_id}.structure.png
 * and generates lib/compound-structure-images.generated.ts with a require() map
 * so the app can resolve compound structure images at runtime.
 *
 * Run: node scripts/generate-compound-images.js
 */

const fs = require('fs');
const path = require('path');

const projectRoot = path.resolve(__dirname, '..');
const dbBase = path.join(projectRoot, 'assets', 'database');
const outPath = path.join(projectRoot, 'lib', 'compound-structure-images.generated.ts');

if (!fs.existsSync(dbBase)) {
  console.error('assets/database not found');
  process.exit(1);
}

const entries = [];
const dbDirs = fs.readdirSync(dbBase);

for (const db of dbDirs) {
  const dbPath = path.join(dbBase, db);
  if (!fs.statSync(dbPath).isDirectory()) continue;
  let compounds;
  try {
    compounds = fs.readdirSync(dbPath);
  } catch {
    continue;
  }
  for (const cid of compounds) {
    const compoundPath = path.join(dbPath, cid);
    if (!fs.statSync(compoundPath).isDirectory()) continue;
    const pngPath = path.join(compoundPath, `${cid}.structure.png`);
    if (fs.existsSync(pngPath)) {
      const key = `${db}/${cid}`;
      const reqPath = `../assets/database/${db}/${cid}/${cid}.structure.png`;
      entries.push({ key, reqPath });
    }
  }
}

const lines = [
  '// Generated by scripts/generate-compound-images.js â€“ do not edit by hand',
  '',
  'export const compoundStructureImageMap: Record<string, number> = {',
  ...entries.map(({ key, reqPath }) => `  ['${key.replace(/'/g, "\\'")}']: require('${reqPath}'),`),
  '};',
  '',
  '/** Normalize database name to match folder names: lowercase, spaces/underscores -> hyphens */',
  'function normalizeDbKey(name: string): string {',
  "  return name.toLowerCase().replace(/[\\s_]+/g, '-').trim();",
  '}',
  '',
  'export function getCompoundStructureImageSource(databaseName: string, compoundId: string): number | null {',
  '  const normalized = normalizeDbKey(databaseName);',
  '  const key = `${normalized}/${compoundId}`;',
  '  return compoundStructureImageMap[key] ?? null;',
  '}',
  '',
];

fs.writeFileSync(outPath, lines.join('\n'), 'utf8');
console.log(`Wrote ${entries.length} entries to ${outPath}`);
